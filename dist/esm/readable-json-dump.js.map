{"version":3,"sources":["../../src/readable-json-dump.js"],"names":["Readable","hash32","OPEN_BUFFER","Buffer","from","MID_BUFFER","CLOSE_BUFFER","COMMA_BUFFER","QUOTE_BUFFER","escapeJsonString","str","replace","ReadableJsonDump","constructor","db","namespace","options","push","insertionIterator","iterator","gt","lt","keyAsBuffer","valueAsBuffer","deletionIterator","didWritePairs","didWriteDeletions","isReading","skipInsertionComma","skipDeletionComma","namespaceLength","length","buckets","bucket","getInsertionPair","Promise","resolve","next","error","k","v","process","nextTick","emit","undefined","getDeletionPair","readFromLevelDbIterators","key","pair","keyStr","slice","toString","escapedKey","buffer","concat","shouldKeepPushing","reject","end","id","idStr","escapedId","_read"],"mappings":"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","sourcesContent":["// @flow\n\nimport { Readable } from 'stream';\nimport { hash32 } from 'farmhash';\n\nconst OPEN_BUFFER = Buffer.from('[\"');\nconst MID_BUFFER = Buffer.from('\",');\nconst CLOSE_BUFFER = Buffer.from(']');\nconst COMMA_BUFFER = Buffer.from(',');\nconst QUOTE_BUFFER = Buffer.from('\"');\n\n// Escape only the characters that are invalid in JSON strings: backslash and quote\nfunction escapeJsonString(str: string): string {\n  return str.replace(/\\\\/g, '\\\\\\\\').replace(/\"/g, '\\\\\"');\n}\n\ntype LevelDBIterator = {next: ((Error | void, Buffer | void, Buffer | void) => void) => void, end: ((Error | void) => void) => void};\n\nexport default class ReadableJsonDump extends Readable {\n  constructor(db:Object, namespace: string, options?:Object) {\n    super(options);\n    this.push(Buffer.from('[['));\n    this.insertionIterator = db.iterator({\n      gt: Buffer.from(`${namespace}>`),\n      lt: Buffer.from(`${namespace}?`),\n      keyAsBuffer: true,\n      valueAsBuffer: true,\n    });\n    this.deletionIterator = db.iterator({\n      gt: Buffer.from(`${namespace}<`),\n      lt: Buffer.from(`${namespace}=`),\n      keyAsBuffer: true,\n      valueAsBuffer: true,\n    });\n    this.didWritePairs = false;\n    this.didWriteDeletions = false;\n    this.isReading = false;\n    this.skipInsertionComma = true;\n    this.skipDeletionComma = true;\n    this.namespaceLength = Buffer.from(`${namespace}>`).length;\n    this.buckets = (options && options.buckets) || 1;\n    this.bucket = (options && options.bucket) || 0;\n  }\n\n  declare namespaceLength: number;\n  declare insertionIterator: LevelDBIterator;\n  declare deletionIterator: LevelDBIterator;\n  declare didWritePairs: boolean;\n  declare didWriteDeletions: boolean;\n  declare skipInsertionComma: boolean;\n  declare skipDeletionComma: boolean;\n  declare isReading: boolean;\n  declare buckets: number;\n  declare bucket: number;\n\n  getInsertionPair():Promise<[Buffer | void, Buffer | void]> {\n    return new Promise((resolve) => {\n      this.insertionIterator.next((error:Error | void, k: Buffer | void, v: Buffer | void) => {\n        if (error) {\n          this.didWritePairs = true;\n          this.didWriteDeletions = true;\n          process.nextTick(() => this.emit('error', error));\n          resolve([undefined, undefined]);\n        } else {\n          resolve([k, v]);\n        }\n      });\n    });\n  }\n\n  getDeletionPair():Promise<[Buffer | void, Buffer | void]> {\n    return new Promise((resolve) => {\n      this.deletionIterator.next((error:Error | void, k: Buffer | void, v: Buffer | void) => {\n        if (error) {\n          this.didWritePairs = true;\n          this.didWriteDeletions = true;\n          process.nextTick(() => this.emit('error', error));\n          resolve([undefined, undefined]);\n        } else {\n          resolve([k, v]);\n        }\n      });\n    });\n  }\n\n  async readFromLevelDbIterators() {\n    if (this.isReading) {\n      return;\n    }\n    this.isReading = true;\n    if (!this.didWritePairs) {\n      while (true) {\n        const [key, pair] = await this.getInsertionPair();\n        if (key && pair) {\n          if (this.buckets > 1) {\n            const bucket = hash32(key) % this.buckets;\n            if (bucket !== this.bucket) {\n              continue;\n            }\n          }\n          // Convert key buffer to string and escape backslashes and quotes\n          const keyStr = key.slice(this.namespaceLength).toString('utf8');\n          const escapedKey = Buffer.from(escapeJsonString(keyStr));\n\n          let buffer;\n          if (this.skipInsertionComma) {\n            this.skipInsertionComma = false;\n            buffer = Buffer.concat([OPEN_BUFFER, escapedKey, MID_BUFFER, pair, CLOSE_BUFFER]);\n          } else {\n            buffer = Buffer.concat([COMMA_BUFFER, OPEN_BUFFER, escapedKey, MID_BUFFER, pair, CLOSE_BUFFER]);\n          }\n          const shouldKeepPushing = this.push(buffer);\n          if (!shouldKeepPushing) {\n            this.isReading = false;\n            return;\n          }\n        } else {\n          break;\n        }\n      }\n      this.push(Buffer.from('],['));\n      this.didWritePairs = true;\n      await new Promise((resolve, reject) => {\n        this.insertionIterator.end((error:Error | void) => {\n          if (error) {\n            reject(error);\n          } else {\n            resolve();\n          }\n        });\n      });\n    }\n    if (!this.didWriteDeletions) {\n      while (true) {\n        const [id, key] = await this.getDeletionPair();\n        if (id && key) {\n          if (this.buckets > 1) {\n            const bucket = hash32(key) % this.buckets;\n            if (bucket !== this.bucket) {\n              continue;\n            }\n          }\n          // Convert buffers to strings and escape backslashes and quotes\n          const idStr = id.slice(this.namespaceLength).toString('utf8');\n          const keyStr = key.toString('utf8');\n          const escapedId = Buffer.from(escapeJsonString(idStr));\n          const escapedKey = Buffer.from(escapeJsonString(keyStr));\n\n          let buffer;\n          if (this.skipDeletionComma) {\n            this.skipDeletionComma = false;\n            buffer = Buffer.concat([OPEN_BUFFER, escapedId, MID_BUFFER, QUOTE_BUFFER, escapedKey, QUOTE_BUFFER, CLOSE_BUFFER]);\n          } else {\n            buffer = Buffer.concat([COMMA_BUFFER, OPEN_BUFFER, escapedId, MID_BUFFER, QUOTE_BUFFER, escapedKey, QUOTE_BUFFER, CLOSE_BUFFER]);\n          }\n          const shouldKeepPushing = this.push(buffer);\n          if (!shouldKeepPushing) {\n            this.isReading = false;\n            return;\n          }\n        } else {\n          break;\n        }\n      }\n      this.didWriteDeletions = true;\n      await new Promise((resolve, reject) => {\n        this.deletionIterator.end((error:Error | void) => {\n          if (error) {\n            reject(error);\n          } else {\n            resolve();\n          }\n        });\n      });\n    }\n    this.push(Buffer.from(']]'));\n    this.push(null);\n    this.isReading = false;\n  }\n\n  _read() {\n    this.readFromLevelDbIterators();\n  }\n}\n\n"],"file":"readable-json-dump.js"}